timeutils
=========

GNU touch のソースコードを改変して Windows でファイルの作成日時、最終アクセス・変更日時を変更できるようにし、いくつかの[オプション](#option)を追加しました。Cygwin 上でもビルド・動作しますが、作成日時の変更はできません。

また、`-d` オプションの[構文解析](./parsing.md)を bison で作成されたソースコードから関数による処理に改変してあります。引数に指定する文字列の構文解析についてはリンク先を参照してください。

## インストール

Windows のコマンドをビルドする場合、Mingw-w64 と GNU make が必要です。64 ビットは `make`、32 ビットは `make x86` を実行すると、bin、x86 ディレクトリにそれぞれ作成されます。GNU C ライブラリ（GLIBC）や msvcrt.dll（MSVCRT）を使用したコマンドをビルドするには `make glibc`、`make msvcrt` を実行し、glibc、msvcrt ディレクトリに作成します。GLIBC のコマンドは gcc、make をインストールした GNU/Linux や Cygwin 上でビルドする必要があります。

インストール用スクリプトはありません。適当なフォルダに置いてパスを通してください。

## コマンド

touch はファイルのタイムスタンプを変更するコマンドです。指定したファイルが存在しない場合、（`-c`、`--no-create` オプションを指定しなければ）サイズ `0` のファイルが作成されます。

**使用法**

```
  touch [オプション]... ファイル...
```

`-a`、`-m` オプションを指定した場合は最終アクセス日時、最終変更日時を変更し、指定しない場合は最終アクセス・変更日時の両方を（GLIBC 以外では作成日時も）変更します。GLIBC では `-h` オプションを指定した場合、参照されるファイルでなく、シンボリックリンク自体のタイムスタンプを変更します。

変更する日時には現在時刻が使用され、以下のようにオプションで指定することもできます。

`-d`、`--date` オプションに指定した引数は時刻変更の文字列として[構文解析](./parsing.md)され、元となる日時からファイル時刻が計算されます。元となる日時は現在時刻ですが、 `-r` を指定した場合は引数に指定したファイルのタイムスタンプ、`-e` を指定した場合は touch に指定したそれぞれのファイルのタイムスタンプになります。

`-r`、`--reference` オプションは引数にファイルを指定し、そのファイルのタイムスタンプを日時に使用します。`-d` と組み合わせて変更する時刻を指定できます。`-e` とは一緒に指定できません。

`-t` オプションは引数に指定した `"[[CC]YY]MMDDhhmm[.ss]"` を変更する日時にします。`-d`、`-e`、`-r` とは一緒に指定できません。

<a id="option"></a>
### 追加したオプション

|    | ロングオプション | オプションの説明                                  |
| -- | :--------------- | :------------------------------------------------ |
| -A | --use-atime      | タイムスタンプの最終アクセス日時を使用する        |
| -b |                  | 作成日時を変更する（GLIBC 非対応）                |
| -B | --use-btime      | タイムスタンプの作成日時を使用する（GLIBC 非対応）|
| -e | --reference-each | 各ファイルのタイムスタンプを日時に使用する        |
| -M | --use-mtime      | タイムスタンプの最終変更日時を使用する            |
|    | --ns-permute     | ナノ秒の数字を並べ替える                          |
|    | --ns-random=SEED | ナノ秒を SEED によってランダムな値に変更する      |
|    | --round-down     | 秒を切り下げる                                    |
|    | --round-up       | 秒を切り下げる                                    |
| -T | --trans-nodst    | 夏時間の影響を移行期間で受けないようにし、[mktime](./mktime.md#trans)<br>の動作を GLIBC から MSVCRT の仕様に変更する<br>（GLIBC、MSVCRT 非対応）|

## テスト用コマンド

時刻を取得したり、計算したり、変更したりする関数のテスト用に作成した下記のコマンドが利用できます。localtime と mktime は同名の POSIX 関数を自作したコマンドが bin、x86 ディレクトリに、GLIBC や MSVCRT の関数を呼び出すコマンドが glibc、msvcrt に作成され、同じ引数を指定して各ライブラリとの動作の違いを確かめられます。

#### adjustday

コマンドの引数に年、月、日（負の値も可能）を指定すると、月と日を正しい範囲に修正して結果を表示します。MSVCRT のコマンドは作成されません。

#### currentft

現在の時刻を 1601-01-01 00:00 UTC からの 100 ナノ秒、または、1970-01-01 00:00 UTC からの秒で表示します。MSVCRT のコマンドは作成されません。

#### getft

コマンドの引数に指定したファイルの時刻を 1601-01-01 00:00 UTC からの 100 ナノ秒、または、1970-01-01 00:00 UTC からの秒で表示します。MSVCRT のコマンドは作成されません。

#### leapdays

コマンドの引数に２つの年（負の値も可能）を指定すると、その期間に含まれるうるう日の数を表示します。`-t` オプションを指定すると、400 で割り切れる年数、残りの 4 で割り切れる年数、4 年未満の各集計テーブルを表示します。MSVCRT のコマンドは作成されません。

#### localtime

コマンドの引数に 1970-01-01 00:00 UTC からの秒を指定すると、ローカル時刻に変換して年、月、日、時、分、秒を表示します。MSVCRT のコマンド以外では負の値も指定可能です。

#### mktime

[mktime](./mktime.md) を参照。

#### modifysec

コマンドの引数に指定した 1970-01-01 00:00 UTC からの秒や小数部分のナノ秒を変更した値を表示します。`-C` や `-F` オプションを指定すると、（小数部分をゼロに設定して）秒の値を切り上げたり、切り下げたりします。また、`-R` や `-P` オプションを指定すると、小数部分をランダムな値に設定したり、 桁を並べ替えたりします。MSVCRT のコマンドは作成されません。

#### parseft

[parseft / setft](./parseft_setft.md) を参照。

#### setft

[parseft / setft](./parseft_setft.md) を参照。

日付や時刻を表示するコマンドでは曜日名、週番号、年内日数、UTC からのオフセット、夏時間かどうかを表示したり、元号、ISO 8601 の形式で表示したりすることができます。詳しくは各コマンドに `--help` を指定して使用方法を参照してください。

コマンドの最初の（`-` を除く）引数に負の値を指定する場合、オプションの後ろに `--` を指定する必要があります。

## ライセンス

touch、parseft、setft は GPL v3.0、それ以外のプログラムは GPL v2.0 で公開されています。
